{% extends "base.html" %}
{% block title %}{{ post.title }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">

        <!-- Back & Actions Bar -->
        <div class="mb-4 d-flex justify-content-between align-items-center flex-wrap gap-2">

            <!-- Back Button -->
            <a href="{{ url_for('index') }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-left-circle me-1"></i>
                Back to Posts
            </a>

            {% if current_user.is_authenticated and current_user.id == post.author.id %}
            <!-- Author Actions -->
            <div class="d-flex gap-2">

                <!-- Edit Button -->
                <a href="{{ url_for('edit_post', post_id=post.id) }}"
                class="btn btn-sm btn-outline-warning">
                    <i class="bi bi-pencil-square me-1"></i>
                    Edit
                </a>

                <!-- Delete Button -->
                <form method="POST"
                    action="{{ url_for('delete_post', post_id=post.id) }}"
                    onsubmit="return confirm('Are you sure you want to delete this post?');">
                    <button type="submit" class="btn btn-sm btn-outline-danger">
                        <i class="bi bi-trash-fill me-1"></i>
                        Delete
                    </button>
                </form>

            </div>
            {% endif %}

        </div>



        <!-- ================= Post Card ================= -->
        <div class="card shadow-sm mb-4">

            <!-- ================= MEDIA SECTION ================= -->

            {% if images %}
            <!-- Image Carousel -->
            <div id="carouselPostMedia" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-inner">
                    {% for media in images %}
                    <div class="carousel-item {% if loop.first %}active{% endif %}">
                        <img src="{{ url_for('static', filename=media.file_path) }}"
                             class="d-block w-100"
                             alt="Post Image"
                             style="max-height: 400px; object-fit: cover;">
                    </div>
                    {% endfor %}
                </div>

                {% if images|length > 1 %}
                <button class="carousel-control-prev" type="button"
                        data-bs-target="#carouselPostMedia" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon"></span>
                </button>
                <button class="carousel-control-next" type="button"
                        data-bs-target="#carouselPostMedia" data-bs-slide="next">
                    <span class="carousel-control-next-icon"></span>
                </button>
                {% endif %}
            </div>

            {% else %}
            <!-- Fallback Image -->
            <img src="{{ url_for('static', filename='images/flask_theme.jpg') }}"
                 class="card-img-top"
                 alt="Default Image"
                 style="max-height: 400px; object-fit: cover;">
            {% endif %}

            <!-- ================= VIDEOS ================= -->
            {% for media in videos %}
            <div class="p-3">
                <video controls class="w-100 rounded">
                    <source src="{{ url_for('static', filename=media.file_path) }}" type="video/mp4">
                </video>
            </div>
            {% endfor %}

            <!-- ================= AUDIOS ================= -->
            {% for media in audios %}
            <div class="p-3">
                <audio controls class="w-100">
                    <source src="{{ url_for('static', filename=media.file_path) }}" type="audio/mpeg">
                </audio>
            </div>
            {% endfor %}

            <!-- ================= POST CONTENT ================= -->
            <div class="card-body">
                <h1 class="card-title mb-3">{{ post.title }}</h1>

                <p class="text-muted small mb-4">
                    By <strong>{{ post.author.username }}</strong>
                    路 {{ post.created_at.strftime('%b %d, %Y') }}
                    {% if post.updated_at %}
                        路 Updated {{ post.updated_at.strftime('%b %d, %Y') }}
                    {% endif %}
                    {% if post.category %}
                        路 <span class="badge bg-secondary">{{ post.category.name }}</span>
                    {% endif %}
                </p>

                <div class="post-content fs-6 lh-lg">
                    {{ post.content | safe }}
                </div>
            </div>
        </div>


        <!-- ================= INTERACTION ================= -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">

                <!-- Likes / Share -->
                <div class="d-flex align-items-center gap-3 mb-3">

                    <form action="{{ url_for('toggle_like', post_id=post.id) }}" method="POST">
                        <button type="submit" class="btn btn-outline-primary btn-sm">
                            わ {{ post.likes | length }} Likes
                        </button>
                    </form>


                    <button class="btn btn-sm btn-outline-secondary"
                            onclick="navigator.clipboard.writeText(window.location.href)">
                         Copy Link
                    </button>
                </div>

                <hr>

                <!-- Comment Form -->
                <h6 class="mb-3">Leave a Comment</h6>

                {% if current_user.is_authenticated %}
                <form method="post" action="{{ url_for('post_comment', post_id=post.id) }}">
                    <div class="mb-3">
                        <textarea class="form-control"
                                  name="comment"
                                  rows="3"
                                  placeholder="Write your comment..."
                                  required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm">
                        Post Comment
                    </button>
                </form>
                {% else %}
                <p class="text-muted small">
                    Please <a href="{{ url_for('login') }}">login</a> to comment.
                </p>
                {% endif %}
            </div>
        </div>

        <!-- ================= COMMENTS ================= -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h6 class="mb-3">Comments</h6>

                {% if post.comments %}
                    {% for comment in post.comments | sort(attribute='created_at') %}
                    <div class="mb-3">
                        <strong>{{ comment.user.username }}</strong>
                        <span class="text-muted small">
                            路 {{ comment.created_at.strftime('%b %d, %Y') }}
                        </span>
                        <p class="mb-1">{{ comment.content }}</p>
                        <hr>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted small">No comments yet.</p>
                {% endif %}
            </div>
        </div>

    </div>
</div>
{% endblock %}
